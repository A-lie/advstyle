# 播放设置功能说明

## 功能概述

播放设置模块用于管理广告播放任务，将节目在特定的时间下发给特定的终端设备，并控制其播放行为。

## 主要功能

### 1. 播放任务管理 (`/schedule`)

#### 功能列表
- ✅ 添加播放任务
- ✅ 编辑播放任务
- ✅ 删除播放任务
- ✅ 启用/停用任务
- ✅ 搜索与筛选

#### 任务配置项
- **基本信息**
  - 任务名称
  - 任务描述
  - 分组

- **设备配置**
  - SN匹配方式（精确匹配/前缀匹配/全部设备）
  - 设备SN号
  - 机型

- **时间配置**
  - 有效期（开始日期 ~ 结束日期）
  - 播放时间（开始时间 ~ 结束时间）
  - 周期设置（周一至周日）

- **节目关联**
  - 选择要播放的节目

- **状态控制**
  - 启用/停用开关

### 2. JSON数据预览 (`/viewer`)

#### 功能特性
- ✅ 模拟设备请求播放列表（7001接口）
- ✅ 查看完整的JSON响应数据
- ✅ 复制JSON到剪贴板
- ✅ 实时查看7002变更通知日志

#### 使用方法
1. 输入设备SN号
2. 点击"请求播放列表"按钮
3. 查看返回的JSON数据
4. 可以复制JSON用于测试

## 接口说明

### 7001 - 获取广告播放任务列表

**终端请求**
```json
{
  "method": 7001,
  "params": {}
}
```

**平台响应**
```json
{
  "method": 7001,
  "data": {
    "playlist": [
      {
        "playid": "play_001",
        "playname": "早间广告任务",
        "date_start": "2025-01-01",
        "date_end": "2025-12-31",
        "time_start": "08:00:00",
        "time_end": "12:00:00",
        "playstatus": true,
        "is_mon": true,
        "is_tue": true,
        "is_wed": true,
        "is_thu": true,
        "is_fri": true,
        "is_sat": true,
        "is_sun": false,
        "advert": {
          "advertid": "adv_001",
          "advertname": "早间促销广告",
          "fullscreen": false,
          "screenwidth": 1920,
          "screenheight": 1080,
          "duration": 0,
          "repeat": 0,
          "arealist": [...]
        }
      }
    ]
  }
}
```

### 7002 - 广告播放任务变更通知

**平台推送**
```json
{
  "method": 7002,
  "params": {
    "type": 1,  // 0-删除, 1-添加/修改
    "playlist": [
      {
        "playid": "play_001",
        ...
      }
    ]
  }
}
```

## Mock数据说明

项目使用Mock数据模拟后端接口，位于 `src/services/mockApi.js`

### Mock API列表

- `getPlayList()` - 获取播放任务列表
- `getAdvertList()` - 获取节目列表
- `addPlayTask(taskData)` - 添加播放任务
- `updatePlayTask(taskData)` - 更新播放任务
- `deletePlayTask(playid)` - 删除播放任务
- `updatePlayTaskStatus(playid, status)` - 更新任务状态
- `deviceRequestPlayList(sn)` - 模拟设备请求播放列表
- `pushPlayListChange(type, playlist)` - 模拟推送变更通知

### 预置Mock数据

系统预置了3个播放任务示例：
1. **早间广告任务** - 工作日早上8:00-12:00播放
2. **下午广告任务** - 每天下午14:00-18:00播放
3. **晚间滚动字幕** - 周末晚上18:00-22:00播放（已停用）

## 使用流程

### 创建播放任务

1. 进入"播放设置"页面
2. 点击"添加播放任务"按钮
3. 填写任务信息：
   - 输入任务名称
   - 选择SN匹配方式
   - 输入设备SN号（如果需要）
   - 选择有效期和播放时间
   - 选择要播放的节目
   - 设置周期（哪些天播放）
4. 点击"确定"保存

### 编辑播放任务

1. 在列表中找到要编辑的任务
2. 点击"编辑"按钮
3. 修改任务信息
4. 点击"确定"保存

### 启用/停用任务

- 直接点击列表中的状态开关即可

### 删除播放任务

1. 点击任务的"删除"按钮
2. 确认删除操作

### 查看JSON数据

1. 进入"JSON预览"页面
2. 输入设备SN号
3. 点击"请求播放列表"
4. 查看返回的JSON数据
5. 可以点击"复制JSON"按钮复制数据

## 技术实现

### 组件结构

```
src/
├── components/
│   ├── PlaySchedule.vue      # 播放设置主页面
│   └── PlayListViewer.vue    # JSON数据预览页面
└── services/
    └── mockApi.js             # Mock API服务
```

### 关键特性

1. **SN匹配逻辑**
   - 精确匹配：设备SN必须完全相同
   - 前缀匹配：设备SN以指定前缀开头
   - 全部设备：匹配所有设备

2. **时间过滤**
   - 根据有效期过滤任务
   - 根据播放时间过滤任务
   - 根据周期设置过滤任务

3. **实时通知**
   - 任务变更时自动触发7002通知
   - 在控制台和JSON预览页面查看通知日志

## 开发调试

### 启动项目

```bash
npm install
npm run dev
```

### 查看Mock数据

打开浏览器控制台，可以看到：
- API请求日志
- 7002变更通知日志
- Mock数据操作记录

### 修改Mock数据

编辑 `src/services/mockApi.js` 文件中的 `mockPlayList` 和 `mockAdvertList` 数组。

## 后续开发建议

1. **接入真实API**
   - 将Mock API替换为真实的后端接口
   - 使用axios或fetch进行HTTP请求

2. **增强功能**
   - 添加批量操作（批量启用/停用/删除）
   - 添加任务复制功能
   - 添加导入/导出功能
   - 添加任务执行日志

3. **优化体验**
   - 添加加载状态提示
   - 添加分页功能
   - 优化搜索筛选
   - 添加数据统计图表

4. **MQTT集成**
   - 集成MQTT客户端
   - 实现真实的设备通信
   - 实时推送7002通知到设备

## 注意事项

1. 当前使用Mock数据，刷新页面后数据会重置
2. 7002通知仅在控制台输出，未实际推送到设备
3. 设备SN匹配逻辑在Mock API中实现，实际应在后端处理
4. 时间格式严格按照需求文档定义（日期：yyyy-MM-dd，时间：HH:mm:ss）

## 相关文档

- [需求文档.md](./需求文档.md) - 完整的系统需求说明
- [README.md](./README.md) - 项目总体说明
