# 节目保存功能说明

## 🎯 功能概述

广告设计器现在支持将设计好的内容保存为节目，并在播放设置中关联使用。

## ✨ 新增功能

### 1. 节目名称输入
在广告设计器的编辑区域顶部，新增了节目名称输入框：
- 位置：编辑区域标题旁边
- 用途：为当前设计的广告内容命名
- 必填：保存为节目时必须填写

### 2. 保存为节目按钮
在工具栏新增"保存为节目"按钮：
- 位置：保存设计和预览按钮之间
- 颜色：橙色（warning类型）
- 功能：将当前设计保存为可在播放设置中使用的节目

## 📋 使用流程

### 完整流程示例

#### 步骤1：设计广告内容
1. 打开广告设计器（`/designer`）
2. 设置画布尺寸（例如：1920x1080）
3. 拖拽组件到画布：
   - 添加图片组件
   - 添加视频组件
   - 添加文字组件
   - 添加容器组件
4. 调整元素位置、大小和属性

#### 步骤2：输入节目名称
在编辑区域顶部的输入框中输入节目名称，例如：
- "商场促销广告"
- "品牌宣传片"
- "新品发布会"
- "节日祝福"

#### 步骤3：保存为节目
1. 点击"保存为节目"按钮
2. 系统会自动：
   - 验证节目名称是否填写
   - 验证是否有设计元素
   - 将设计转换为节目格式
   - 保存到节目列表
3. 显示成功提示
4. 询问是否跳转到播放设置页面

#### 步骤4：创建播放任务
1. 如果选择跳转，会自动进入播放设置页面
2. 点击"添加播放任务"
3. 在"关联节目"下拉列表中，可以看到刚才保存的节目
4. 选择该节目并配置播放参数：
   - 设备SN号
   - 播放时间
   - 周期设置
   - 等等
5. 保存播放任务

## 🔄 数据转换说明

### 设计元素 → 节目区域

广告设计器中的元素会自动转换为节目的区域（arealist）：

| 设计元素 | 节目区域类型 | 说明 |
|---------|------------|------|
| 文字组件 | areatype: 0 | 文本区域 |
| 图片组件 | areatype: 1 | 图片区域 |
| 视频组件 | areatype: 2 | 视频区域 |
| 容器组件 | areatype: 1 | 作为背景区域 |

### 元素属性映射

#### 文字组件
```javascript
{
  texts: ['文本1', '文本2'],      // → 多个资源
  textAlign: 'scroll',            // → show: 3 (滚动)
  fontSize: 24,                   // → font.fontsize
  fontColor: '#000000',           // → font.textcolor
  fontWeight: true,               // → font.bold: 1
  scrollSpeed: 5,                 // → font.roll
  interval: 3000                  // → showtime
}
```

#### 图片组件
```javascript
{
  images: [{url, name, size}],    // → 多个资源
  displayMode: 'center',          // → show: 0 (居中)
  displayMode: 'stretch',         // → show: 1 (拉伸)
  interval: 3000                  // → showtime
}
```

#### 视频组件
```javascript
{
  videoUrl: 'blob:...',           // → file.fileurl
  videoName: 'video.mp4',         // → file.filename
  displayMode: 'center',          // → show: 0 (居中)
  displayMode: 'stretch'          // → show: 1 (拉伸)
}
```

#### 通用属性
```javascript
{
  x: 100,                         // → areax
  y: 100,                         // → areay
  width: 300,                     // → areawidth
  height: 200,                    // → areaheight
  opacity: 255,                   // → alpha
  backgroundColor: '#FFFFFF'      // → bkcolor
}
```

## 📊 生成的节目数据结构

```json
{
  "advertid": "adv_1732363200000_abc123",
  "advertname": "商场促销广告",
  "fullscreen": false,
  "screenwidth": 1920,
  "screenheight": 1080,
  "duration": 0,
  "repeat": 0,
  "arealist": [
    {
      "areaid": "area_1",
      "areaname": "文字 1",
      "areax": 100,
      "areay": 100,
      "areawidth": 800,
      "areaheight": 100,
      "areatype": 0,
      "alpha": 255,
      "bkcolor": "#FFFFFF",
      "reslist": [
        {
          "resid": "res_1_0",
          "file": null,
          "show": 3,
          "showtime": 3000,
          "text": "欢迎光临！",
          "font": {
            "fontname": "sans-serif",
            "textcolor": "#FF0000",
            "fontsize": 48,
            "bold": 1,
            "roll": 5
          }
        }
      ]
    }
  ]
}
```

## 🎨 示例场景

### 场景1：简单的文字滚动广告

**设计步骤**：
1. 输入节目名称："欢迎标语"
2. 添加文字组件
3. 设置文本内容："欢迎光临！本店全场8折优惠！"
4. 设置对齐方式：滚动
5. 设置字体大小：48
6. 设置字体颜色：红色
7. 设置滚动速度：5
8. 点击"保存为节目"

**生成的节目**：
- 节目名称：欢迎标语
- 包含1个文本区域
- 文本滚动显示

### 场景2：图片轮播广告

**设计步骤**：
1. 输入节目名称："产品展示"
2. 添加图片组件
3. 上传多张产品图片
4. 设置切换间隔：5000ms
5. 设置显示方式：等比例居中
6. 点击"保存为节目"

**生成的节目**：
- 节目名称：产品展示
- 包含1个图片区域
- 多张图片轮播

### 场景3：视频+文字组合

**设计步骤**：
1. 输入节目名称："品牌宣传"
2. 添加视频组件（全屏）
3. 上传宣传视频
4. 添加文字组件（底部）
5. 设置文本："品牌口号"
6. 点击"保存为节目"

**生成的节目**：
- 节目名称：品牌宣传
- 包含2个区域：视频区域 + 文本区域
- 视频播放，底部显示文字

## ⚠️ 注意事项

### 1. 节目名称
- **必须填写**：保存为节目前必须输入节目名称
- **唯一性**：如果存在同名节目，会覆盖原有节目
- **建议**：使用有意义的名称，便于在播放设置中识别

### 2. 设计元素
- **至少一个**：必须至少添加一个元素才能保存为节目
- **完整配置**：确保所有元素都已正确配置（如图片已上传、文本已填写）

### 3. 文件引用
- **Blob URL**：视频使用Blob URL，刷新页面后会失效
- **Base64**：图片使用Base64编码，数据较大
- **建议**：实际使用时应上传到服务器，使用HTTP URL

### 4. 数据持久化
- **当前**：使用内存存储，刷新页面后节目仍然保留（存储在mockAdvertList中）
- **实际**：应该保存到数据库

## 🔧 技术实现

### 核心方法

#### saveAsProgram()
保存为节目的主方法：
```javascript
async saveAsProgram() {
  // 1. 验证节目名称
  if (!this.programName.trim()) {
    this.$message.error('请先输入节目名称')
    return
  }
  
  // 2. 验证元素
  if (this.elements.length === 0) {
    this.$message.warning('请先添加一些元素再保存为节目')
    return
  }
  
  // 3. 转换元素为区域列表
  const arealist = this.convertElementsToAreas()
  
  // 4. 构建节目对象
  const programData = {
    advertid: 'adv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
    advertname: this.programName.trim(),
    fullscreen: false,
    screenwidth: this.canvasWidth,
    screenheight: this.canvasHeight,
    duration: 0,
    repeat: 0,
    arealist: arealist
  }
  
  // 5. 保存节目
  await mockPlayListAPI.saveProgram(programData)
  
  // 6. 提示成功
  this.$message.success(`节目"${this.programName}"已保存`)
  
  // 7. 询问是否跳转
  this.$confirm('是否跳转到播放设置页面？', '提示', {
    confirmButtonText: '立即跳转',
    cancelButtonText: '稍后再说',
    type: 'success'
  }).then(() => {
    this.$router.push('/schedule')
  })
}
```

#### convertElementsToAreas()
将设计元素转换为节目区域：
```javascript
convertElementsToAreas() {
  return this.elements.map(element => {
    return {
      areaid: 'area_' + element.id,
      areaname: this.getElementName(element),
      areax: Math.round(element.x),
      areay: Math.round(element.y),
      areawidth: Math.round(element.width),
      areaheight: Math.round(element.height),
      areatype: this.getAreaType(element.type),
      alpha: element.opacity || 255,
      bkcolor: element.backgroundColor || '#FFFFFF',
      reslist: this.convertElementToResources(element)
    }
  })
}
```

### Mock API

#### saveProgram()
保存节目到Mock数据：
```javascript
async saveProgram(programData) {
  await delay()
  
  // 检查是否已存在同名节目
  const existingIndex = mockAdvertList.findIndex(
    adv => adv.advertname === programData.advertname
  )
  
  if (existingIndex !== -1) {
    // 更新现有节目
    mockAdvertList[existingIndex] = programData
  } else {
    // 添加新节目
    mockAdvertList.push(programData)
  }
  
  return {
    success: true,
    message: '节目保存成功',
    data: programData
  }
}
```

## 🚀 后续优化建议

### 1. 节目管理页面
创建专门的节目管理页面：
- 查看所有节目列表
- 编辑节目信息
- 删除节目
- 预览节目效果
- 复制节目

### 2. 节目模板
提供预设的节目模板：
- 文字滚动模板
- 图片轮播模板
- 视频播放模板
- 组合模板

### 3. 节目分组
支持节目分组管理：
- 按类型分组
- 按用途分组
- 自定义分组

### 4. 节目导入导出
支持节目的导入导出：
- 导出为JSON文件
- 从JSON文件导入
- 批量导入导出

### 5. 节目预览
增强节目预览功能：
- 全屏预览
- 实时预览
- 多设备预览

## 📝 常见问题

**Q: 保存为节目后，原来的设计会丢失吗？**
A: 不会。保存为节目只是将当前设计转换为节目格式并保存，不影响设计器中的内容。

**Q: 可以修改已保存的节目吗？**
A: 当前版本不支持直接修改。如果需要修改，可以重新设计并使用相同的节目名称保存，会覆盖原有节目。

**Q: 节目名称可以重复吗？**
A: 可以，但会覆盖同名的旧节目。建议使用唯一的节目名称。

**Q: 保存的节目在哪里查看？**
A: 在播放设置页面，添加或编辑播放任务时，"关联节目"下拉列表中可以看到所有已保存的节目。

**Q: 刷新页面后节目还在吗？**
A: 在当前Mock数据实现中，节目会保留。但实际使用时应该保存到数据库。

**Q: 视频文件会一起保存吗？**
A: 当前只保存视频的Blob URL引用，刷新页面后会失效。实际使用时应该上传视频到服务器。

## 🎉 总结

通过这个功能，你可以：
1. ✅ 在广告设计器中设计广告内容
2. ✅ 为设计命名并保存为节目
3. ✅ 在播放设置中选择节目创建播放任务
4. ✅ 实现从设计到播放的完整流程

这样就打通了广告设计和播放设置两个模块，形成了完整的工作流程！
